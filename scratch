ref_dir=/oak/stanford/groups/horence/sequin_transcriptome

fastas=/oak/stanford/groups/horence/julias/V3/synthetic/pairwise_test/consensus_anchors/*fasta

star_index=/oak/stanford/groups/horence/kaitlin/sequin_data/STAR_index
genome_fasta=/oak/stanford/groups/horence/sequin_transcriptome/rnasequin_decoychr_2.4.fa
gtf=/oak/stanford/groups/horence/sequin_transcriptome/rnasequin_annotation_2.4.gtf 

python3 bin/create_annotator.py --gtf ${gtf} -a sequin_transcriptome
exon_pickle=/oak/stanford/groups/horence/kaitlin/sequin_data/pickles/sequin_transcriptome_exon_bounds.pkl
splice_pickle=/oak/stanford/groups/horence/kaitlin/sequin_data/pickles/sequin_transcriptome_splices.pkl

STAR \
    --runMode genomeGenerate \
    --genomeDir ${star_index} \
    --genomeFastaFiles ${genome_fasta} \
    --sjdbGTFfile ${gtf}


for fasta in ${fastas}
do
    name=alignments/$(basename ${fasta} | sed 's/.fasta//g')
    STAR \
        --genomeDir ${star_index} \
        --readFilesIn ${fasta} \
        --twopassMode Basic \
        --alignIntronMax 1000000 \
        --outFileNamePrefix ${name}_ \
        --outSAMtype BAM Unsorted \
        --outSAMattributes All \
        --chimOutType WithinBAM SoftClip Junctions \
        --chimJunctionOverhangMin 10 \
        --chimSegmentReadGapMax 0 \
        --chimOutJunctionFormat 1 \
        --chimSegmentMin 12 \
        --chimScoreJunctionNonGTAG -4 \
        --chimNonchimScoreDropMin 10 \
        --quantMode GeneCounts \
        --sjdbGTFfile ${gtf} \
        --outReadsUnmapped Fastx
done

for file in /oak/stanford/groups/horence/kaitlin/sequin_data/alignments/*SJ.out.tab
do
    name=$(basename ${file} | sed 's/_SJ.out.tab//g')
    awk -v OFS='\t' '{print $1,$2-1,$3+1,$4,$5,$6,$7,$8,$9}' ${file} > positionModified_${name}.tab
    python3 bin/ann_splices.py \
        --in_file positionModified_${name}.tab \
        --out_file output/${name}.txt \
        --exon_pickle ${exon_pickle} \
        --splice_pickle ${splice_pickle} 
done
